angular.module("CanvasViewer",[]).directive("canvasViewer",["$window","$http",function(e,t){return{scope:{imageSource:"=src",overlays:"=overlays",title:"@title",isTiff:"=isTiff"},restrict:"E",template:'<div class="viewer-container"><canvas class="viewer" ng-mouseleave="canMove=false"ng-mousedown="mousedown($event)"ng-mouseup="mouseup($event)"ng-init="canMove=false"ng-mousemove="mousedrag($event,canMove)"></canvas><div class="title" ng-if="title!=null">{{title}}</div><div class="command"><div class="btn btn-info" ng-click="rotateleft()"><i class="fa fa-rotate-left"></i></div><div class="btn btn-info" ng-click="rotateright()"><i class="fa fa-rotate-right"></i></div><div class="btn btn-info" ng-click="zoomout()"><i class="fa fa-search-minus"></i></div><div class="btn btn-info" ng-click="zoomin()"><i class="fa fa-search-plus"></i></div></div></div>',link:function(e,t,n,a){function i(e){return"image/tiff"==e||"image/tif"==e}function o(){var e=s.canvas,t=f.width/2,n=f.height/2;s.clearRect(0,0,e.width,e.height),s.save(),s.translate(h.x+t,h.y+n),s.rotate(v*Math.PI/180),s.scale(u,u),s.drawImage(f,-t,-n,f.width,f.height),s.restore(),g.length>0&&angular.forEach(g,function(e){s.save(),s.translate(h.x+t,h.y+n),s.rotate(v*Math.PI/180),s.scale(u,u),s.beginPath(),s.rect(e.x-t,e.y-n,e.w,e.h),s.fillStyle="rgba(255,0,0,0.4)",s.fill(),s.lineWidth=1,s.strokeStyle="rgb(255,0,128)",s.stroke(),s.restore()})}var l=t.find("canvas")[0],s=l.getContext("2d"),r=angular.element(t.find("div")[0])[0];directiveParentNode=r.parentNode.parentNode;var c=l.parentNode;s.canvas.width=c.clientWidth,s.canvas.height=c.clientHeight,s.canvas.style.width=c.clientWidth,s.canvas.style.height=c.clientHeight;var f=null,u=1,v=0,d={x:0,y:0},h={x:0,y:0},g=[];e.$watch("imageSource",function(e){if(void 0!==e&&null!==e)if(f=new Image,f.onload=function(){o()},"object"==typeof e){var t=new FileReader;t.onload=function(){if(i(e.type)){Tiff.initialize({TOTAL_MEMORY:167772160});var n=new Tiff({buffer:t.result});f.width=n.width(),f.height=n.height(),f.src=n.toDataURL()}else f.src=t.result},i(e.type)?t.readAsArrayBuffer(e):t.readAsDataURL(e)}else"string"==typeof e&&(f.src=e)}),e.$watch("overlays",function(e,t){null!==e&&null!==t&&(angular.forEach(e,function(e){g=[],g.push(e)}),o())},!0),angular.element(l).bind("DOMMouseScroll mousewheel onmousewheel",function(t){var n=window.event||t,a=Math.max(-1,Math.min(1,n.wheelDelta||-n.detail));a>0?e.zoomin():e.zoomout(),n.returnValue=!1,n.preventDefault&&n.preventDefault()}),angular.element(l).bind("mousedown",function(t){e.canMove=!0,d.x=t.offsetX,d.y=t.offsetY}),angular.element(l).bind("mouseup",function(t){e.canMove=!1}),angular.element(l).bind("mousemove",function(t){if(null!==f&&e.canMove){var n=t.offsetX,a=t.offsetY,i=n-d.x,l=a-d.y;h.x+=i,h.y+=l,o(),d.x=n,d.y=a}}),e.zoomin=function(){u+=.1,u>=6&&(u=6),o()},e.zoomout=function(){u-=.1,.05>=u&&(u=.05),o()},e.rotateleft=function(){v-=90,-360>=v&&(v=0),o()},e.rotateright=function(){v+=90,v>=360&&(v=0),o()}}}}]);