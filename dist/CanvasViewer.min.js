function FormatReader(){this.mimetype=["image/png","image/jpeg"],"undefined"!=typeof PDFJS&&this.mimetype.push("application/pdf"),"undefined"!=typeof Tiff&&(this.mimetype.push("image/tif"),this.mimetype.push("image/tiff"));try{var e=$window.AudioContext||$window.webkitAudioContext||$window.mozAudioContext||$window.msAudioContext;"undefined"!=typeof e&&(this.mimetype.push("audio/x-wav"),this.mimetype.push("audio/wav"),this.mimetype.push("audio/x-ogg"),this.mimetype.push("audio/ogg"),this.mimetype.push("audio/x-mpeg"),this.mimetype.push("audio/mpeg"))}catch(t){}}FormatReader.prototype={pdfReader:function(e,t,i,o){function n(e,o,n){void 0==o&&(o=a.currentPage),void 0==n&&(n=e.page);var r=document.createElement("canvas"),s=r.getContext("2d");if(null!=n){e.rendering=!0,e.oldwidth=e.width,e.oldheight=e.height;var d=n.getViewport(e.options.zoom.value,0);return r.width=d.width,r.height=d.height,n.render({canvasContext:s,viewport:d,intent:"display"}).then(function(){var n=new Image;n.onload=function(){e.width=n.width,e.height=n.height,t.controls.filmstrip?(n.pageNum=o,e.images.push(n),e.images.length==t.controls.totalPage&&(e.images.sort(function(e,t){return e.pageNum-t.pageNum}),i())):(a.img=n,i()),e.rendered=!0,e.rendering=!1},n.src=r.toDataURL()})}}t.controls.toolbar&&(t.controls.image=!0,t.controls.sound=!1),this.reader=new FileReader;var a=this;return a.$q=o,a._pdfDoc=null,a.viewport=null,a.img=new Image,a.rendered=!1,a.width=-1,a.height=-1,a.oldwidth=-1,a.oldheight=-1,a.data=null,a.page=null,a.options=t,a.currentPage=-1,a.rendering=!1,a.isZoom=!1,a.images=[],this.refresh=function(){if(null!=a._pdfDoc)if(parent.rendered=!1,t.controls.filmstrip){var e=1,i=[];a.images=[];for(var e=1;e<=t.controls.totalPage;e++)i.push(a._pdfDoc.getPage(e));a.$q.all(i).then(function(e){for(var t=0;t<e.length;t++)n(a,e[t].pageIndex,e[t])})}else a.currentPage!=a.options.controls.numPage?a._pdfDoc.getPage(a.options.controls.numPage).then(function(e){n(a,a.options.controls.numPage,e)}):n(a,a.options.controls.numPage,page)},this.reader.onload=function(){var e=new Uint8Array(a.reader.result);PDFJS.getDocument({data:e}).then(function(e){a._pdfDoc=e,t.controls.totalPage=e.numPages,t.controls.numPage=1,a._pdfDoc.getMetadata().then(function(e){t.info=e.info,t.info.metadata=e.metadata}),a.refresh()})},this.reader.readAsArrayBuffer(e),this},tiffReader:function(e,t,i){t.controls.toolbar&&(t.controls.image=!0,t.controls.sound=!1),this.reader=new FileReader;var o=this;return o.rendered=!1,o.tiff=null,o.img=new Image,o.data=null,o.width=-1,o.height=-1,o.options=t,o.images=[],o.currentPage=-1,o.isZoom=!0,this.refresh=function(){if(null==o.tiff&&(o.tiff=new Tiff({buffer:o.reader.result}),o.options.controls.totalPage=o.tiff.countDirectory(),o.options.controls.numPage=1,o.options.info={width:o.tiff.width(),height:o.tiff.height(),compression:o.tiff.getField(Tiff.Tag.COMPRESSION),document:o.tiff.getField(Tiff.Tag.DOCUMENTNAME),description:o.tiff.getField(Tiff.Tag.IMAGEDESCRIPTION),orientation:o.tiff.getField(Tiff.Tag.ORIENTATION),xresolution:o.tiff.getField(Tiff.Tag.XRESOLUTION),yresolution:o.tiff.getField(Tiff.Tag.YRESOLUTION)}),o.options.controls.numPage>o.options.controls.totalPage&&(o.options.controls.numPage=o.options.controls.totalPage),o.options.controls.filmstrip){o.images=[];for(var e=0;e<o.tiff.countDirectory();e++)o.tiff.setDirectory(e),0==e&&(o.width=o.tiff.width(),o.height=o.tiff.height()),o.images[e]=new Image,o.images[e].onload=function(){console.log(o.images.length,o.tiff.countDirectory()),1==o.images.length&&(o.img=o.images[0]),i()},o.images[e].src=o.tiff.toDataURL(),o.images[e].pageNum=e}else if(o.currentPage!=o.options.controls.numPage){var t=new Image;t.onload=function(){o.img=t,i(),o.rendered=!0},o.tiff.setDirectory(o.options.controls.numPage-1),o.width=o.tiff.width(),o.height=o.tiff.height(),t.src=o.tiff.toDataURL(),o.currentPage=o.options.controls.numPage}},this.reader.onload=function(){null!=o.tiff&&(o.tiff.close(),o.tiff=null),Tiff.initialize({TOTAL_MEMORY:83886080}),o.refresh()},this.reader.readAsArrayBuffer(e),this},imageReader:function(e,t,i){t.controls.toolbar&&(t.controls.image=!0,t.controls.sound=!1),this.reader=new FileReader;var o=this;return o.img=new Image,o.img.onload=function(){o.width=o.img.width,o.height=o.img.height,i(),o.rendered=!0},o.data=null,o.width=-1,o.height=-1,t.info={},o.isZoom=!0,o.rendered=!1,this.reader.onload=function(){o.img.src=o.reader.result},"string"==typeof e?o.img.src=e:this.reader.readAsDataURL(e),t.controls.totalPage=1,t.controls.numPage=1,this.refresh=function(){},this},mpegReader:function(e,t,i){},wavReader:function(e,t,i){t.controls.toolbar&&(t.controls.image=!1,t.controls.sound=!0),this.reader=new FileReader;var o=this,n=t.ctx;this.width=n.canvas.width,this.height=n.canvas.height;try{$window.AudioContext=$window.AudioContext||$window.webkitAudioContext||$window.mozAudioContext||$window.msAudioContext,$window.requestAnimationFrame=$window.requestAnimationFrame||$window.webkitRequestAnimationFrame||$window.mozRequestAnimationFrame||$window.msRequestAnimationFrame,$window.cancelAnimationFrame=$window.cancelAnimationFrame||$window.webkitCancelAnimationFrame||$window.mozCancelAnimationFrame||$window.msCancelAnimationFrame;var a=new AudioContext;this.reader.onload=function(){a.decodeAudioData(o.reader.result,function(e){var i=n.createLinearGradient(0,0,0,o.height);i.addColorStop(1,"#000000"),i.addColorStop(.75,"#ff0000"),i.addColorStop(.25,"#ffff00"),i.addColorStop(0,"#ffffff");var r=a.createScriptProcessor(2048,1,1),s=a.createBufferSource();t.adsrc=s,s.buffer=e;var d=a.createAnalyser();d.smoothingTimeConstant=.3,d.fftSize=512,s.connect(d),d.connect(r),r.onaudioprocess=function(){var e=new Uint8Array(d.frequencyBinCount);d.getByteFrequencyData(e),n.clearRect(0,0,n.canvas.width,n.canvas.height),n.fillStyle=i;for(var t=0;t<e.length;t++){var a=e[t];n.fillRect(5*t,o.height-a,3,o.height)}},r.connect(a.destination),s.connect(a.destination)})},this.reader.readAsArrayBuffer(e)}catch(r){}},CreateReader:function(e,t){var i=null;switch(""==e&&(e=this.GuessMimeType(t)),e.toLowerCase()){case"image/tif":case"image/tiff":i={create:this.tiffReader};break;case"application/pdf":i={create:this.pdfReader};break;case"image/png":case"image/jpeg":i={create:this.imageReader};break;case"audio/x-wav":case"audio/wav":case"audio/x-ogg":case"audio/ogg":i={create:this.wavReader};break;case"audio/x-mpeg":case"audio/mpeg":i={create:this.mpegReader}}return i},IsSupported:function(e){return-1!=this.mimetype.indexOf(e)},GuessMimeType:function(e){var t="";if(""==e.type){var i=e.name;t="image/"+i.substring(i.indexOf(".")+1)}return t.toLowerCase()}};
angular.module("CanvasViewer",[]).directive("canvasViewer",["$window","$http","$timeout","$q",function(o,t,n,e){var i=new FormatReader;return{scope:{imageSource:"=src",overlays:"=overlays",title:"@title",options:"=options"},restrict:"E",template:'<div class="viewer-container"><canvas class="viewer" ng-mouseleave="canMove=false"ng-mousedown="mousedown($event)"ng-mouseup="mouseup($event)"ng-init="canMove=false"ng-mousemove="mousedrag($event,canMove)"></canvas><div class="title" ng-if="title!=null">{{title}}</div><div class="command" ng-if="options.controls.image"><div class="btn btn-info" ng-click="options.controls.numPage=options.controls.numPage-1" ng-hide="options.controls.totalPage==1"><i class="fa fa-minus"></i></div><div class="btn btn-info" ng-hide="options.controls.totalPage==1">{{options.controls.numPage}}/{{options.controls.totalPage}}</div><div class="btn btn-info" ng-click="options.controls.numPage=options.controls.numPage+1" ng-hide="options.controls.totalPage==1"><i class="fa fa-plus"></i></div><div class="btn btn-info" ng-click="resizeTo(\'page\')"><i class="fa fa-file-o"></i></div><div class="btn btn-info" ng-click="rotate(-1)" ng-hide="options.controls.disableRotate"><i class="fa fa-rotate-left"></i></div><div class="btn btn-info" ng-click="rotate(1)" ng-hide="options.controls.disableRotate"><i class="fa fa-rotate-right"></i></div><div class="btn btn-info" ng-click="zoom(-1)" ng-hide="options.controls.disableZoom"><i class="fa fa-search-minus"></i></div><div class="btn btn-info" ng-click="zoom(1)" ng-hide="options.controls.disableZoom"><i class="fa fa-search-plus"></i></div></div><div class="command" ng-if="options.controls.sound"><div class="btn btn-info" ng-click="stop()"><i class="fa fa-stop"></i></div><div class="btn btn-info" ng-click="play()"><i class="fa fa-play"></i></div></div></div>',link:function(t,n,a,s){function l(){null!=b&&(b.rendered?c():t.resizeTo(t.options.controls.fit))}function c(){if(null!=b){var o=t.options,n=d.canvas,e=b.width*o.zoom.value/2,i=b.height*o.zoom.value/2;if(d.clearRect(0,0,n.width,n.height),d.save(),d.translate(g.x+e,g.y+i),d.rotate(o.rotate.value*Math.PI/180),d.translate(-e,-i),b.isZoom&&d.scale(o.zoom.value,o.zoom.value),null!=b.data){var a=d.createImageData(b.width,b.height);a.data.set(b.data),d.putImageData(a,0,0)}o.controls.filmstrip&&1!=o.controls.totalPage?null!=b.images&&angular.forEach(b.images,function(o){d.drawImage(o,0,0,o.width,o.height),d.beginPath(),d.rect(0,0,o.width,o.height),d.lineWidth=.2,d.strokeStyle="#000000",d.stroke(),d.translate(0,o.height+15)}):null!=b.img&&(d.drawImage(b.img,0,0,b.width,b.height),d.beginPath(),d.rect(0,0,b.width,b.height),d.lineWidth=.2,d.strokeStyle="#000000",d.stroke()),d.restore(),y.length>0&&angular.forEach(y,function(t){d.save(),d.translate(g.x+e,g.y+i),d.rotate(o.rotate.value*Math.PI/180),d.translate(-e,-i),d.scale(o.zoom.value,o.zoom.value),d.beginPath(),d.rect(t.x,t.y,t.w,t.h),d.fillStyle=t.color,d.globalAlpha=.4,d.fill(),d.lineWidth=1,d.strokeStyle=t.color,d.stroke(),d.restore()})}}function r(){t.$applyAsync(function(){var o=p.parentNode;d.canvas.width=o.clientWidth,d.canvas.height=o.clientHeight,d.canvas.style.width=o.clientWidth,d.canvas.style.height=o.clientHeight,c()})}function u(){return m.width!=p.parentNode.clientWidth&&(m.width=p.parentNode.clientWidth),m.height!=p.parentNode.clientHeight&&(m.height=p.parentNode.clientHeight),m}var p=n.find("canvas")[0],d=p.getContext("2d"),h=angular.element(n.find("div")[0])[0];directiveParentNode=h.parentNode.parentNode;var v=p.parentNode;d.canvas.width=v.clientWidth,d.canvas.height=v.clientHeight,d.canvas.style.width=v.clientWidth,d.canvas.style.height=v.clientHeight;var m={height:v.clientHeight,width:v.clientWidth},f={x:0,y:0},g={x:0,y:0},w={x:0,y:0},y=[],b=null;t.options=angular.merge({},{ctx:null,adsrc:null,zoom:{value:1,step:.1,min:.05,max:6},rotate:{value:0,step:90},controls:{toolbar:!0,image:!0,sound:!1,fit:"page",disableZoom:!1,disableMove:!1,disableRotate:!1,numPage:1,totalPage:1,filmstrip:!1},info:{}},t.options),t.options.ctx=d,t.$watch("imageSource",function(o){if(void 0!==o&&null!==o)if(t.options.zoom.value=1,t.options.rotate.value=0,f={x:0,y:0},g={x:0,y:0},"object"==typeof o)if(i.IsSupported(o.type)){var n=i.CreateReader(o.type,o);b=n.create(o,t.options,l,e)}else console.log(o.type," not supported !");else"string"==typeof o&&(b=i.CreateReader("image/jpeg").create(o,t.options,l,e))}),t.$watch("overlays",function(o,t){null!==o&&null!==t&&(y=[],angular.forEach(o,function(o){y.push(o)}),c())},!0),t.$watch("options.zoom.value",function(){t.options.controls.disableZoom||c()}),t.$watch("options.rotate.value",function(){t.options.controls.disableRotate||c()}),t.$watch("options.controls.fit",function(o){t.resizeTo(o)}),t.$watch("options.controls.filmstrip",function(o){o?b.refresh():(b.refresh(),c())}),t.$watch("options.controls.numPage",function(o){t.options.controls.numPage<1&&(t.options.controls.numPage=1),t.options.controls.numPage>t.options.controls.totalPage&&(t.options.controls.numPage=t.options.controls.totalPage),null!=b&&(t.options.controls.filmstrip?(g.y=(t.options.controls.numPage-1)*-(b.height+15),c()):b.refresh())}),angular.element(p).bind("DOMMouseScroll mousewheel onmousewheel",function(o){var n=window.event||o,e=Math.max(-1,Math.min(1,n.wheelDelta||-n.detail));t.options.controls.filmstrip?(g.y+=50*e,t.$applyAsync(function(){c()})):e>0?t.zoom(1):t.zoom(-1),n.returnValue=!1,n.preventDefault&&n.preventDefault()}),angular.element(p).bind("mousedown",function(o){t.options.controls.disableMove||(t.canMove=!0,f.x=o.offsetX,f.y=o.offsetY)}),angular.element(p).bind("mouseup",function(o){t.options.controls.disableMove||(t.canMove=!1)}),angular.element(p).bind("mousemove",function(o){if(w.x=o.offsetX,w.y=o.offsetY,!t.options.controls.disableMove&&null!==b&&t.canMove){var n=o.offsetX,e=o.offsetY,i=n-f.x,a=e-f.y;g.x+=i,g.y+=a,c(),f.x=n,f.y=e}}),t.zoom=function(o){t.$applyAsync(function(){var n,e,i=0,a=0;b.isZoom?(n=b.width*t.options.zoom.value,e=b.height*t.options.zoom.value):(n=b.oldwidth,e=b.height),t.options.zoom.value+=t.options.zoom.step*o,t.options.zoom.value=Math.round(100*t.options.zoom.value)/100,t.options.zoom.value>=t.options.zoom.max&&(t.options.zoom.value=t.options.zoom.max),t.options.zoom.value<=t.options.zoom.min&&(t.options.zoom.value=t.options.zoom.min),b.refresh(),b.isZoom?(i=b.width*t.options.zoom.value,a=b.height*t.options.zoom.value):(i=b.width,a=b.height),g.x=g.x-(i-n)/2,g.y=g.y-(a-e)/2})},t.rotate=function(o){t.$applyAsync(function(){t.options.rotate.value+=t.options.rotate.step*o,(t.options.rotate.value<=-360||t.options.rotate.value>=360)&&(t.options.rotate.value=0),c()})};var z=function(){var o=d.canvas.width/2,n=o-b.width*t.options.zoom.value/2;f={x:n,y:0},g={x:n,y:0}};t.resizeTo=function(o){if(null!=d.canvas&&null!=b){var n=(t.options,d.canvas.height/b.height),e=d.canvas.width/b.width;switch(b.isZoom||(n*=t.options.zoom.value,e*=t.options.zoom.value),o){case"width":t.options.zoom.value=e;break;case"height":t.options.zoom.value=n;break;case"page":default:t.options.zoom.value=Math.min(n,e)}t.$applyAsync(function(){t.options.zoom.value=Math.round(100*t.options.zoom.value)/100,z(),t.options.controls.fit=o,b.isZoom?c():b.refresh()})}},t.play=function(){null!=t.options.adsrc&&t.options.adsrc.start(0)},t.stop=function(){null!=t.options.adsrc&&t.options.adsrc.stop(0)},t.$watch(u,function(){r()},!0),angular.element(o).bind("resize",function(){r()})}}}]);