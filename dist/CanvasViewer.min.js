function FormatReader(){this.mimetype=["image/png","image/jpeg"],"undefined"!=typeof PDFJS&&(this.mimetype.push("application/pdf"),PDFJS.disableWorker=!1),"undefined"!=typeof Tiff&&(this.mimetype.push("image/tif"),this.mimetype.push("image/tiff"));try{var e=$window.AudioContext||$window.webkitAudioContext||$window.mozAudioContext||$window.msAudioContext;"undefined"!=typeof e&&(this.mimetype.push("audio/x-wav"),this.mimetype.push("audio/wav"),this.mimetype.push("audio/x-ogg"),this.mimetype.push("audio/ogg"),this.mimetype.push("audio/x-mpeg"),this.mimetype.push("audio/mpeg"))}catch(t){}}FormatReader.prototype={pdfReader:function(e,t,i,o,n,a){function r(e,o,n){void 0==o&&(o=d.currentPage),void 0==n&&(n=e.page);var a=document.createElement("canvas"),r=a.getContext("2d");if(null!=n){e.rendering=!0,e.oldwidth=e.width,e.oldheight=e.height,0==Math.abs(e.options.zoom.value)&&(e.options.zoom.value=1);var s=n.getViewport(e.options.zoom.value,0);return r.canvas.width=s.width,r.canvas.height=s.height,n.render({canvasContext:r,viewport:s,intent:"display"}).then(function(){if(e.width=s.width,e.height=s.height,t.controls.filmStrip){var n=r.getImageData(0,0,s.width,s.height);n.pageNum=o,e.data.push(n),e.data.length==t.controls.totalPage&&(e.data.sort(function(e,t){return e.pageNum-t.pageNum}),e.rendered=!0,i(),e.rendering=!1)}else d.data=r.getImageData(0,0,s.width,s.height),d.rendered=!0,i(),e.rendering=!1})}}t.controls.toolbar&&(t.controls.image=!0,t.controls.sound=!1),this.reader=new FileReader;var d=this;return d.context=a,d.$q=o,d._pdfDoc=null,d.viewport=null,d.img=new Image,d.rendered=!1,d.width=-1,d.height=-1,d.oldwidth=-1,d.oldheight=-1,d.data=null,d.page=null,d.options=t,d.currentPage=-1,d.rendering=!1,d.isZoom=!1,d.data=[],d.triggerRefresh=!1,this.refresh=function(){if(null!=d._pdfDoc&&!parent.rendering)if(d.rendered=!1,t.controls.filmStrip){var e=1,i=[];d.data=[];for(var e=1;e<=t.controls.totalPage;e++)i.push(d._pdfDoc.getPage(e));d.$q.all(i).then(function(e){for(var t=0;t<e.length;t++)r(d,e[t].pageIndex,e[t])})}else d.currentPage!=d.options.controls.numPage?d._pdfDoc.getPage(d.options.controls.numPage).then(function(e){r(d,d.options.controls.numPage,e)}):r(d,d.options.controls.numPage,page)},this.reader.onload=function(){var e=new Uint8Array(d.reader.result);PDFJS.getDocument({data:e}).then(function(e){d._pdfDoc=e,t.controls.totalPage=e.numPages,t.controls.numPage=1,d._pdfDoc.getMetadata().then(function(e){t.info=e.info,t.info.metadata=e.metadata}),d.refresh()})},this.reader.readAsArrayBuffer(e),this},tiffReader:function(e,t,i){t.controls.toolbar&&(t.controls.image=!0,t.controls.sound=!1),this.reader=new FileReader;var o=this;return o.rendered=!1,o.tiff=null,o.img=null,o.data=null,o.width=-1,o.height=-1,o.options=t,o.images=[],o.currentPage=-1,o.isZoom=!0,this.refresh=function(){if(void 0!=o.reader.result)if(null==o.tiff&&(o.tiff=new Tiff({buffer:o.reader.result}),o.options.controls.totalPage=o.tiff.countDirectory(),o.options.controls.numPage=1,o.options.info={width:o.tiff.width(),height:o.tiff.height(),compression:o.tiff.getField(Tiff.Tag.COMPRESSION),document:o.tiff.getField(Tiff.Tag.DOCUMENTNAME),description:o.tiff.getField(Tiff.Tag.IMAGEDESCRIPTION),orientation:o.tiff.getField(Tiff.Tag.ORIENTATION),xresolution:o.tiff.getField(Tiff.Tag.XRESOLUTION),yresolution:o.tiff.getField(Tiff.Tag.YRESOLUTION)}),o.options.controls.numPage>o.options.controls.totalPage&&(o.options.controls.numPage=o.options.controls.totalPage),o.options.controls.filmStrip){o.images=[];for(var e=0;e<o.tiff.countDirectory();e++)o.tiff.setDirectory(e),0==e&&(o.width=o.tiff.width(),o.height=o.tiff.height()),o.images[e]=new Image,o.images[e].onload=function(){1==o.images.length&&(o.img=o.images[0]),i(),o.rendered=!0},o.images[e].src=o.tiff.toDataURL(),o.images[e].pageNum=e}else o.currentPage!=o.options.controls.numPage&&(o.tiff.setDirectory(o.options.controls.numPage-1),o.width=o.tiff.width(),o.height=o.tiff.height(),o.img=new Image,o.img.onload=function(){i(),o.rendered=!0},o.img.src=o.tiff.toDataURL(),o.currentPage=o.options.controls.numPage)},this.reader.onload=function(){null!=o.tiff&&(o.tiff.close(),o.tiff=null),Tiff.initialize({TOTAL_MEMORY:83886080}),o.refresh()},this.reader.readAsArrayBuffer(e),this},imageReader:function(e,t,i){t.controls.toolbar&&(t.controls.image=!0,t.controls.sound=!1),this.reader=new FileReader;var o=this;return o.img=new Image,o.img.onload=function(){o.width=o.img.width,o.height=o.img.height,i(),o.rendered=!0},o.data=null,o.width=-1,o.height=-1,t.info={},o.isZoom=!0,o.rendered=!1,this.reader.onload=function(){o.img.src=o.reader.result},"string"==typeof e?o.img.src=e:this.reader.readAsDataURL(e),t.controls.totalPage=1,t.controls.numPage=1,this.refresh=function(){},this},mpegReader:function(e,t,i){},wavReader:function(e,t,i){t.controls.toolbar&&(t.controls.image=!1,t.controls.sound=!0),this.reader=new FileReader;var o=this,n=t.ctx;this.width=n.canvas.width,this.height=n.canvas.height;try{$window.AudioContext=$window.AudioContext||$window.webkitAudioContext||$window.mozAudioContext||$window.msAudioContext,$window.requestAnimationFrame=$window.requestAnimationFrame||$window.webkitRequestAnimationFrame||$window.mozRequestAnimationFrame||$window.msRequestAnimationFrame,$window.cancelAnimationFrame=$window.cancelAnimationFrame||$window.webkitCancelAnimationFrame||$window.mozCancelAnimationFrame||$window.msCancelAnimationFrame;var a=new AudioContext;this.reader.onload=function(){a.decodeAudioData(o.reader.result,function(e){var i=n.createLinearGradient(0,0,0,o.height);i.addColorStop(1,"#000000"),i.addColorStop(.75,"#ff0000"),i.addColorStop(.25,"#ffff00"),i.addColorStop(0,"#ffffff");var r=a.createScriptProcessor(2048,1,1),d=a.createBufferSource();t.adsrc=d,d.buffer=e;var s=a.createAnalyser();s.smoothingTimeConstant=.3,s.fftSize=512,d.connect(s),s.connect(r),r.onaudioprocess=function(){var e=new Uint8Array(s.frequencyBinCount);s.getByteFrequencyData(e),n.clearRect(0,0,n.canvas.width,n.canvas.height),n.fillStyle=i;for(var t=0;t<e.length;t++){var a=e[t];n.fillRect(5*t,o.height-a,3,o.height)}},r.connect(a.destination),d.connect(a.destination)})},this.reader.readAsArrayBuffer(e)}catch(r){}},CreateReader:function(e,t){var i=null;switch(""==e&&(e=this.GuessMimeType(t)),e.toLowerCase()){case"image/tif":case"image/tiff":i={create:this.tiffReader};break;case"application/pdf":i={create:this.pdfReader};break;case"image/png":case"image/jpeg":i={create:this.imageReader};break;case"audio/x-wav":case"audio/wav":case"audio/x-ogg":case"audio/ogg":i={create:this.wavReader};break;case"audio/x-mpeg":case"audio/mpeg":i={create:this.mpegReader}}return i},IsSupported:function(e){return this.mimetype.indexOf(e)!=-1},GuessMimeType:function(e){var t="";if(""==e.type){var i=e.name;t="image/"+i.substring(i.indexOf(".")+1)}return t.toLowerCase()}};
angular.module("CanvasViewer",[]).directive("canvasViewer",["$window","$http","$timeout","$q",function(o,t,n,e){var i=new FormatReader;return{scope:{imageSource:"=src",overlays:"=overlays",title:"@title",options:"=options"},restrict:"E",template:'<div class="viewer-container"><canvas class="viewer" ng-mouseleave="canMove=false"ng-mousedown="mousedown($event)"ng-mouseup="mouseup($event)"ng-init="canMove=false"ng-mousemove="mousedrag($event,canMove)"></canvas><div class="title" ng-if="title!=null">{{title}}</div><div class="command" ng-if="options.controls.image"><button class="btn btn-info" ng-click="options.controls.numPage=options.controls.numPage-1" ng-hide="options.controls.totalPage==1"><i class="fa fa-minus"></i></button><button class="btn btn-info" ng-hide="options.controls.totalPage==1">{{options.controls.numPage}}/{{options.controls.totalPage}}</button><button class="btn btn-info" ng-click="options.controls.numPage=options.controls.numPage+1" ng-hide="options.controls.totalPage==1"><i class="fa fa-plus"></i></button><button class="btn btn-info" ng-click="resizeTo(\'page\')"><i class="fa fa-file-o"></i></button><button class="btn btn-info" ng-click="rotate(-1)" ng-hide="options.controls.disableRotate"><i class="fa fa-rotate-left"></i></button><button class="btn btn-info" ng-click="rotate(1)" ng-hide="options.controls.disableRotate"><i class="fa fa-rotate-right"></i></button><button class="btn btn-info" ng-click="zoom(-1)" ng-hide="options.controls.disableZoom"><i class="fa fa-search-minus"></i></button><button class="btn btn-info" ng-click="zoom(1)" ng-hide="options.controls.disableZoom"><i class="fa fa-search-plus"></i></button></div><div class="command" ng-if="options.controls.sound"><button class="btn btn-info" ng-click="stop()"><i class="fa fa-stop"></i></button><button class="btn btn-info" ng-click="play()"><i class="fa fa-play"></i></button></div></div>',link:function(t,a,s,l){function r(){null!=z&&(z.rendered?c():t.resizeTo(t.options.controls.fit))}function c(){if(null!=z&&z.rendered){var o=t.options,n=g.canvas,e=z.width*o.zoom.value/2,i=z.height*o.zoom.value/2;if(g.clearRect(0,0,n.width,n.height),g.save(),g.translate(b.x+e,b.y+i),g.rotate(o.rotate.value*Math.PI/180),g.translate(-e,-i),z.isZoom&&g.scale(o.zoom.value,o.zoom.value),o.controls.filmStrip&&1!=o.controls.totalPage){if(null!=z.images&&angular.forEach(z.images,function(o){g.drawImage(o,0,0,o.width,o.height),g.beginPath(),g.rect(0,0,o.width,o.height),g.lineWidth=.2,g.strokeStyle="#000000",g.stroke(),g.translate(0,o.height+15)}),null!=z.data){var a=0;angular.forEach(z.data,function(o){g.putImageData(o,b.x,b.y+a),g.beginPath(),g.rect(0,0,z.width,z.height),g.lineWidth=.2,g.strokeStyle="#000000",g.stroke(),a+=z.height+15,g.translate(0,a)})}}else null!=z.img&&(g.drawImage(z.img,0,0,z.width,z.height),g.beginPath(),g.rect(0,0,z.width,z.height),g.lineWidth=.2,g.strokeStyle="#000000",g.stroke()),null!=z.data&&(g.putImageData(z.data,b.x,b.y),g.beginPath(),g.rect(0,0,z.width,z.height),g.lineWidth=.2,g.strokeStyle="#000000",g.stroke());g.restore(),w.length>0&&angular.forEach(w,function(t){g.save(),g.translate(b.x+e,b.y+i),g.rotate(o.rotate.value*Math.PI/180),g.translate(-e,-i),g.scale(o.zoom.value,o.zoom.value),g.beginPath(),g.rect(t.x,t.y,t.w,t.h),g.fillStyle=t.color,g.globalAlpha=.4,g.fill(),g.lineWidth=1,g.strokeStyle=t.color,g.stroke(),g.restore()})}}function u(){t.$applyAsync(function(){var o=p.parentNode;g.canvas.width=o.clientWidth,g.canvas.height=o.clientHeight,c()})}function h(){return f.width!=p.parentNode.clientWidth&&(f.width=p.parentNode.clientWidth),f.height!=p.parentNode.clientHeight&&(f.height=p.parentNode.clientHeight),f}var p=a.find("canvas")[0],g=p.getContext("2d"),m=angular.element(a.find("div")[0])[0];directiveParentNode=m.parentNode.parentNode;var d=p.parentNode;g.canvas.width=d.clientWidth,g.canvas.height=d.clientHeight;var f={height:d.clientHeight,width:d.clientWidth},v={x:0,y:0},b={x:0,y:0},y={x:0,y:0},w=[],z=null;t.options=angular.merge({},{ctx:null,adsrc:null,zoom:{value:1,step:.1,min:.05,max:6},rotate:{value:0,step:90},controls:{toolbar:!0,image:!0,sound:!1,fit:"page",disableZoom:!1,disableMove:!1,disableRotate:!1,numPage:1,totalPage:1,filmStrip:!1},info:{}},t.options),t.options.ctx=g,t.$watch("imageSource",function(o){if(void 0!==o&&null!==o)if(t.options.zoom.value=1,t.options.rotate.value=0,v={x:0,y:0},b={x:0,y:0},"object"==typeof o)if(i.IsSupported(o.type)){var a=i.CreateReader(o.type,o);z=a.create(o,t.options,r,e,n,g)}else console.log(o.type," not supported !");else"string"==typeof o&&(z=i.CreateReader("image/jpeg").create(o,t.options,r,e,n))}),t.$watch("overlays",function(o,t){null!==o&&null!==t&&(w=[],angular.forEach(o,function(o){w.push(o)}),c())},!0),t.$watch("options.zoom.value",function(){t.options.controls.disableZoom||c()}),t.$watch("options.rotate.value",function(){t.options.controls.disableRotate||c()}),t.$watch("options.controls.fit",function(o){t.resizeTo(o)}),t.$watch("options.controls.filmStrip",function(o){o?(t.options.controls.disableMove=!0,t.options.controls.disableRotate=!0):(t.options.controls.disableMove=!1,t.options.controls.disableRotate=!1),null!=z.refresh&&z.refresh()}),t.$watch("options.controls.numPage",function(o){t.options.controls.numPage<1&&(t.options.controls.numPage=1),t.options.controls.numPage>t.options.controls.totalPage&&(t.options.controls.numPage=t.options.controls.totalPage),null!=z&&(t.options.controls.filmStrip?(b.y=(t.options.controls.numPage-1)*-(z.height+15),c()):null!=z.refresh&&z.refresh())}),angular.element(p).bind("DOMMouseScroll mousewheel onmousewheel",function(n){var e=o.event||n,i=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail));t.options.controls.filmStrip?(b.y+=50*i,b.y>15&&(b.y=15),z.images?b.y-z.height*t.options.zoom.value<-(z.height+15)*z.images.length*t.options.zoom.value&&(b.y=-(z.height+15)*z.images.length+z.height):b.y-z.height*t.options.zoom.value<-z.height*t.options.zoom.value&&(b.y=-z.height*t.options.zoom.value),t.$applyAsync(function(){c()})):i>0?t.zoom(1):t.zoom(-1),e.returnValue=!1,e.preventDefault&&e.preventDefault()}),angular.element(p).bind("mousedown",function(o){t.options.controls.disableMove||(t.canMove=!0,v.x=o.offsetX,v.y=o.offsetY)}),angular.element(p).bind("mouseup",function(o){t.options.controls.disableMove||(t.canMove=!1)}),angular.element(p).bind("mousemove",function(o){if(y.x=o.offsetX,y.y=o.offsetY,!t.options.controls.disableMove&&null!==z&&t.canMove){var n=o.offsetX,e=o.offsetY,i=n-v.x,a=e-v.y;b.x+=i,b.y+=a,c(),v.x=n,v.y=e}}),t.zoom=function(o){t.$applyAsync(function(){var n,e,i=0,a=0;z.isZoom?(n=z.width*t.options.zoom.value,e=z.height*t.options.zoom.value):(n=z.oldwidth,e=z.height),t.options.zoom.value+=t.options.zoom.step*o,t.options.zoom.value=Math.round(100*t.options.zoom.value)/100,t.options.zoom.value>=t.options.zoom.max&&(t.options.zoom.value=t.options.zoom.max),t.options.zoom.value<=t.options.zoom.min&&(t.options.zoom.value=t.options.zoom.min),null!=z.refresh&&z.refresh(),z.isZoom?(i=z.width*t.options.zoom.value,a=z.height*t.options.zoom.value):(i=z.width,a=z.height),b.x=b.x-(i-n)/2,b.y=b.y-(a-e)/2})},t.rotate=function(o){t.$applyAsync(function(){t.options.rotate.value+=t.options.rotate.step*o,(t.options.rotate.value<=-360||t.options.rotate.value>=360)&&(t.options.rotate.value=0),c()})};var P=function(){var o=g.canvas.width/2,n=0,e=g.canvas.height/2,i=0;n=o-z.width*t.options.zoom.value/2,i=e-z.height*t.options.zoom.value/2,v={x:n,y:i},b={x:n,y:i}};t.resizeTo=function(o){if(null!=g.canvas&&null!=z){var n=(t.options,g.canvas.height/z.height),e=g.canvas.width/z.width;z.isZoom||(n*=t.options.zoom.value,e*=t.options.zoom.value);var i=function(){var o=Math.min(g.canvas.height,g.canvas.width),t=Math.min(z.height,z.width);return o<t?Math.min(n,e):1};switch(o){case"width":t.options.zoom.value=e;break;case"height":t.options.zoom.value=n;break;case"page":default:t.options.zoom.value=i()}t.$applyAsync(function(){t.options.zoom.value=Math.round(100*t.options.zoom.value)/100,t.options.controls.fit=o,z.isZoom?(P(),c()):(null!=z.refresh&&z.refresh(),P())}),t.options.rotate.value=0}},t.play=function(){null!=t.options.adsrc&&t.options.adsrc.start(0)},t.stop=function(){null!=t.options.adsrc&&t.options.adsrc.stop(0)},t.$watch(h,function(){u()},!0)}}}]);