function FormatReader(){this.mimetype=["image/png","image/jpeg"],"undefined"!=typeof PDFJS&&this.mimetype.push("application/pdf"),"undefined"!=typeof Tiff&&(this.mimetype.push("image/tif"),this.mimetype.push("image/tiff"));try{var e=$window.AudioContext||$window.webkitAudioContext||$window.mozAudioContext||$window.msAudioContext;"undefined"!=typeof e&&(this.mimetype.push("audio/x-wav"),this.mimetype.push("audio/wav"),this.mimetype.push("audio/x-ogg"),this.mimetype.push("audio/ogg"),this.mimetype.push("audio/x-mpeg"),this.mimetype.push("audio/mpeg"))}catch(t){}}FormatReader.prototype={pdfReader:function(e,t,i){function o(e){null==e.page||e.rendering||(e.rendering=!0,e.oldwidth=e.width,e.oldheight=e.height,t.controls.filmStrip&&1==n.currentPage?(e.viewport=e.page.getViewport(e.options.zoom.value,0),a.width=e.viewport.width,a.height=e.viewport.height):t.controls.filmStrip||(e.viewport=e.page.getViewport(e.options.zoom.value,0),a.width=e.viewport.width,a.height=e.viewport.height),e.page.render({canvasContext:r,viewport:e.viewport,intent:"display"}).then(function(){e.img.onload=function(){e.width=e.img.width,e.height=e.img.height,t.controls.filmStrip?e.images.push(e.img):i(),e.rendered=!0,e.rendering=!1},e.img.src=a.toDataURL()}))}t.controls.toolbar&&(t.controls.image=!0,t.controls.sound=!1),this.reader=new FileReader;var n=this,a=document.createElement("canvas"),r=a.getContext("2d");return n._pdfDoc=null,n.viewport=null,n.img=new Image,n.rendered=!1,n.width=-1,n.height=-1,n.oldwidth=-1,n.oldheight=-1,n.data=null,n.page=null,n.options=t,n.currentPage=-1,n.rendering=!1,n.isZoom=!1,n.images=[],this.refresh=function(){if(null!=n._pdfDoc)if(parent.rendered=!1,t.controls.filmStrip)for(var e=1;e<=t.controls.totalPage;e++)n._pdfDoc.getPage(e).then(function(t){n.page=t,o(n),n.currentPage=e});else n.currentPage!=n.options.controls.numPage?n._pdfDoc.getPage(n.options.controls.numPage).then(function(e){n.page=e,o(n),n.currentPage=n.options.controls.numPage}):o(n)},this.reader.onload=function(){var e=new Uint8Array(n.reader.result);PDFJS.getDocument({data:e}).then(function(e){n._pdfDoc=e,t.controls.totalPage=e.numPages,t.controls.numPage=1,n._pdfDoc.getMetadata().then(function(e){t.info=e.info,t.info.metadata=e.metadata}),n.refresh()})},this.reader.readAsArrayBuffer(e),this},tiffReader:function(e,t,i){t.controls.toolbar&&(t.controls.image=!0,t.controls.sound=!1),this.reader=new FileReader;var o=this;return o.rendered=!1,o.tiff=null,o.img=new Image,o.img.onload=function(){i(),o.rendered=!0},o.data=null,o.width=-1,o.height=-1,o.options=t,o.currentPage=-1,o.isZoom=!0,this.refresh=function(){null==o.tiff&&(o.tiff=new Tiff({buffer:o.reader.result}),o.options.controls.totalPage=o.tiff.countDirectory(),o.options.controls.numPage=1,o.options.info={width:o.tiff.width(),height:o.tiff.height(),compression:o.tiff.getField(Tiff.Tag.COMPRESSION),document:o.tiff.getField(Tiff.Tag.DOCUMENTNAME),description:o.tiff.getField(Tiff.Tag.IMAGEDESCRIPTION),orientation:o.tiff.getField(Tiff.Tag.ORIENTATION),xresolution:o.tiff.getField(Tiff.Tag.XRESOLUTION),yresolution:o.tiff.getField(Tiff.Tag.YRESOLUTION)}),o.options.controls.numPage>o.options.controls.totalPage&&(o.options.controls.numPage=o.options.controls.totalPage),o.currentPage!=o.options.controls.numPage&&(o.tiff.setDirectory(o.options.controls.numPage),o.width=o.tiff.width(),o.height=o.tiff.height(),o.img.src=o.tiff.toDataURL(),o.currentPage=o.options.controls.numPage)},this.reader.onload=function(){null!=o.tiff&&(o.tiff.close(),o.tiff=null),Tiff.initialize({TOTAL_MEMORY:83886080}),o.refresh()},this.reader.readAsArrayBuffer(e),this},imageReader:function(e,t,i){t.controls.toolbar&&(t.controls.image=!0,t.controls.sound=!1),this.reader=new FileReader;var o=this;return o.img=new Image,o.img.onload=function(){o.width=o.img.width,o.height=o.img.height,i(),o.rendered=!0},o.data=null,o.width=-1,o.height=-1,t.info={},o.isZoom=!0,o.rendered=!1,this.reader.onload=function(){o.img.src=o.reader.result},"string"==typeof e?o.img.src=e:this.reader.readAsDataURL(e),t.controls.totalPage=1,t.controls.numPage=1,this.refresh=function(){},this},mpegReader:function(e,t,i){},wavReader:function(e,t,i){t.controls.toolbar&&(t.controls.image=!1,t.controls.sound=!0),this.reader=new FileReader;var o=this,n=t.ctx;this.width=n.canvas.width,this.height=n.canvas.height;try{$window.AudioContext=$window.AudioContext||$window.webkitAudioContext||$window.mozAudioContext||$window.msAudioContext,$window.requestAnimationFrame=$window.requestAnimationFrame||$window.webkitRequestAnimationFrame||$window.mozRequestAnimationFrame||$window.msRequestAnimationFrame,$window.cancelAnimationFrame=$window.cancelAnimationFrame||$window.webkitCancelAnimationFrame||$window.mozCancelAnimationFrame||$window.msCancelAnimationFrame;var a=new AudioContext;this.reader.onload=function(){a.decodeAudioData(o.reader.result,function(e){var i=n.createLinearGradient(0,0,0,o.height);i.addColorStop(1,"#000000"),i.addColorStop(.75,"#ff0000"),i.addColorStop(.25,"#ffff00"),i.addColorStop(0,"#ffffff");var r=a.createScriptProcessor(2048,1,1),d=a.createBufferSource();t.adsrc=d,d.buffer=e;var s=a.createAnalyser();s.smoothingTimeConstant=.3,s.fftSize=512,d.connect(s),s.connect(r),r.onaudioprocess=function(){var e=new Uint8Array(s.frequencyBinCount);s.getByteFrequencyData(e),n.clearRect(0,0,n.canvas.width,n.canvas.height),n.fillStyle=i;for(var t=0;t<e.length;t++){var a=e[t];n.fillRect(5*t,o.height-a,3,o.height)}},r.connect(a.destination),d.connect(a.destination)})},this.reader.readAsArrayBuffer(e)}catch(r){}},CreateReader:function(e,t){var i=null;switch(""==e&&(e=this.GuessMimeType(t)),e.toLowerCase()){case"image/tif":case"image/tiff":i={create:this.tiffReader};break;case"application/pdf":i={create:this.pdfReader};break;case"image/png":case"image/jpeg":i={create:this.imageReader};break;case"audio/x-wav":case"audio/wav":case"audio/x-ogg":case"audio/ogg":i={create:this.wavReader};break;case"audio/x-mpeg":case"audio/mpeg":i={create:this.mpegReader}}return i},IsSupported:function(e){return-1!=this.mimetype.indexOf(e)},GuessMimeType:function(e){var t="";if(""==e.type){var i=e.name;t="image/"+i.substring(i.indexOf(".")+1)}return t.toLowerCase()}};
angular.module("CanvasViewer",[]).directive("canvasViewer",["$window","$http","$timeout",function(o,t,e){var n=new FormatReader;return{scope:{imageSource:"=src",overlays:"=overlays",title:"@title",options:"=options"},restrict:"E",template:'<div class="viewer-container"><canvas class="viewer" ng-mouseleave="canMove=false"ng-mousedown="mousedown($event)"ng-mouseup="mouseup($event)"ng-init="canMove=false"ng-mousemove="mousedrag($event,canMove)"></canvas><div class="title" ng-if="title!=null">{{title}}</div><div class="command" ng-if="options.controls.image"><div class="btn btn-info" ng-click="options.controls.numPage=options.controls.numPage-1" ng-hide="options.controls.totalPage==1"><i class="fa fa-minus"></i></div><div class="btn btn-info" ng-hide="options.controls.totalPage==1">{{options.controls.numPage}}/{{options.controls.totalPage}}</div><div class="btn btn-info" ng-click="options.controls.numPage=options.controls.numPage+1" ng-hide="options.controls.totalPage==1"><i class="fa fa-plus"></i></div><div class="btn btn-info" ng-click="resizeTo(\'page\')"><i class="fa fa-file-o"></i></div><div class="btn btn-info" ng-click="rotate(-1)" ng-hide="options.controls.disableRotate"><i class="fa fa-rotate-left"></i></div><div class="btn btn-info" ng-click="rotate(1)" ng-hide="options.controls.disableRotate"><i class="fa fa-rotate-right"></i></div><div class="btn btn-info" ng-click="zoom(-1)" ng-hide="options.controls.disableZoom"><i class="fa fa-search-minus"></i></div><div class="btn btn-info" ng-click="zoom(1)" ng-hide="options.controls.disableZoom"><i class="fa fa-search-plus"></i></div></div><div class="command" ng-if="options.controls.sound"><div class="btn btn-info" ng-click="stop()"><i class="fa fa-stop"></i></div><div class="btn btn-info" ng-click="play()"><i class="fa fa-play"></i></div></div></div>',link:function(t,e,i,a){function s(){null!=b&&(b.rendered?l():t.resizeTo(t.options.controls.fit))}function l(){if(null!=b){var o=t.options,e=d.canvas,n=b.width*o.zoom.value/2,i=b.height*o.zoom.value/2;if(d.clearRect(0,0,e.width,e.height),d.save(),d.translate(m.x+n,m.y+i),d.rotate(o.rotate.value*Math.PI/180),d.translate(-n,-i),b.isZoom&&d.scale(o.zoom.value,o.zoom.value),null!=b.data){var a=d.createImageData(b.width,b.height);a.data.set(b.data),d.putImageData(a,0,0)}null!=b.img&&(d.drawImage(b.img,0,0,b.width,b.height),d.beginPath(),d.rect(0,0,b.width,b.height),d.lineWidth=.2,d.strokeStyle="#000000",d.stroke()),d.restore(),w.length>0&&angular.forEach(w,function(t){d.save(),d.translate(m.x+n,m.y+i),d.rotate(o.rotate.value*Math.PI/180),d.translate(-n,-i),d.scale(o.zoom.value,o.zoom.value),d.beginPath(),d.rect(t.x,t.y,t.w,t.h),d.fillStyle=t.color,d.globalAlpha=.4,d.fill(),d.lineWidth=1,d.strokeStyle=t.color,d.stroke(),d.restore()})}}function c(){t.$applyAsync(function(){var o=u.parentNode;d.canvas.width=o.clientWidth,d.canvas.height=o.clientHeight,d.canvas.style.width=o.clientWidth,d.canvas.style.height=o.clientHeight,l()})}function r(){return h.width!=u.parentNode.clientWidth&&(h.width=u.parentNode.clientWidth),h.height!=u.parentNode.clientHeight&&(h.height=u.parentNode.clientHeight),h}var u=e.find("canvas")[0],d=u.getContext("2d"),p=angular.element(e.find("div")[0])[0];directiveParentNode=p.parentNode.parentNode;var v=u.parentNode;d.canvas.width=v.clientWidth,d.canvas.height=v.clientHeight,d.canvas.style.width=v.clientWidth,d.canvas.style.height=v.clientHeight;var h={height:v.clientHeight,width:v.clientWidth},f={x:0,y:0},m={x:0,y:0},g={x:0,y:0},w=[],b=null;t.options=angular.merge({},{ctx:null,adsrc:null,zoom:{value:1,step:.1,min:.05,max:6},rotate:{value:0,step:90},controls:{toolbar:!0,image:!0,sound:!1,fit:"page",disableZoom:!1,disableMove:!1,disableRotate:!1,numPage:1,totalPage:1,filmstrip:!1},info:{}},t.options),t.options.ctx=d,t.$watch("imageSource",function(o){if(void 0!==o&&null!==o)if(t.options.zoom.value=1,t.options.rotate.value=0,f={x:0,y:0},m={x:0,y:0},"object"==typeof o)if(n.IsSupported(o.type)){var e=n.CreateReader(o.type,o);b=e.create(o,t.options,s)}else console.log(o.type," not supported !");else"string"==typeof o&&(b=n.CreateReader("image/jpeg").create(o,t.options,s))}),t.$watch("overlays",function(o,t){null!==o&&null!==t&&(w=[],angular.forEach(o,function(o){w.push(o)}),l())},!0),t.$watch("options.zoom.value",function(){t.options.controls.disableZoom||l()}),t.$watch("options.rotate.value",function(){t.options.controls.disableRotate||l()}),t.$watch("options.controls.fit",function(o){t.resizeTo(o)}),t.$watch("options.controls.numPage",function(o){t.options.controls.numPage<1&&(t.options.controls.numPage=1),t.options.controls.numPage>t.options.controls.totalPage&&(t.options.controls.numPage=t.options.controls.totalPage),null!=b&&b.refresh()}),angular.element(u).bind("DOMMouseScroll mousewheel onmousewheel",function(o){var e=window.event||o,n=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail));n>0?t.zoom(1):t.zoom(-1),e.returnValue=!1,e.preventDefault&&e.preventDefault()}),angular.element(u).bind("mousedown",function(o){t.options.controls.disableMove||(t.canMove=!0,f.x=o.offsetX,f.y=o.offsetY)}),angular.element(u).bind("mouseup",function(o){t.options.controls.disableMove||(t.canMove=!1)}),angular.element(u).bind("mousemove",function(o){if(g.x=o.offsetX,g.y=o.offsetY,!t.options.controls.disableMove&&null!==b&&t.canMove){var e=o.offsetX,n=o.offsetY,i=e-f.x,a=n-f.y;m.x+=i,m.y+=a,l(),f.x=e,f.y=n}}),t.zoom=function(o){t.$applyAsync(function(){var e,n,i=0,a=0;b.isZoom?(e=b.width*t.options.zoom.value,n=b.height*t.options.zoom.value):(e=b.oldwidth,n=b.height),t.options.zoom.value+=t.options.zoom.step*o,t.options.zoom.value=Math.round(100*t.options.zoom.value)/100,t.options.zoom.value>=t.options.zoom.max&&(t.options.zoom.value=t.options.zoom.max),b.refresh(),b.isZoom?(i=b.width*t.options.zoom.value,a=b.height*t.options.zoom.value):(i=b.width,a=b.height),m.x=m.x-(i-e)/2,m.y=m.y-(a-n)/2})},t.rotate=function(o){t.$applyAsync(function(){t.options.rotate.value+=t.options.rotate.step*o,(t.options.rotate.value<=-360||t.options.rotate.value>=360)&&(t.options.rotate.value=0),l()})};var y=function(){var o=d.canvas.width/2,e=o-b.width*t.options.zoom.value/2;f={x:e,y:0},m={x:e,y:0}};t.resizeTo=function(o){if(null!=d.canvas&&null!=b){var e=(t.options,d.canvas.height/b.height),n=d.canvas.width/b.width;switch(b.isZoom||(e*=t.options.zoom.value,n*=t.options.zoom.value),o){case"width":t.options.zoom.value=n;break;case"height":t.options.zoom.value=e;break;case"page":default:t.options.zoom.value=Math.min(e,n)}t.$applyAsync(function(){t.options.zoom.value=Math.round(100*t.options.zoom.value)/100,y(),t.options.controls.fit=o,b.isZoom?l():b.refresh()})}},t.play=function(){null!=t.options.adsrc&&t.options.adsrc.start(0)},t.stop=function(){null!=t.options.adsrc&&t.options.adsrc.stop(0)},t.$watch(r,function(){c()},!0),angular.element(o).bind("resize",function(){c()})}}}]);