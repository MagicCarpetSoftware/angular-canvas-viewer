angular.module("RaphaelViewer",[]).directive("imageViewer",["$window",function(e){return{scope:{imageSource:"=src",overlays:"=overlays",title:"@title"},restrict:"E",template:'<div class="viewer"width="100%" height="100%"ng-mouseleave="canMove=false"ng-mousedown="mousedown($event)"ng-mouseup="mouseup($event)"ng-init="canMove=false"ng-mousemove="mousedrag($event,canMove)"><div class="title" ng-if="title!=null">{{title}}</div><div class="command"><div class="btn btn-info" ng-click="rotateleft()"><i class="fa fa-rotate-left"></i></div><div class="btn btn-info" ng-click="rotateright()"><i class="fa fa-rotate-right"></i></div><div class="btn btn-info" ng-click="zoomout()"><i class="fa fa-search-minus"></i></div><div class="btn btn-info" ng-click="zoomin()"><i class="fa fa-search-plus"></i></div></div></div>',link:function(t,n,o,i){function a(){h.transform(Raphael.format("s{3},{4},0,0t{1},{2}r{0},0,0",f,v.x,v.y,r,r))}var l=n.find("div")[0],c=Raphael(l,e.width,e.height),s=null,r=1,f=0,u={x:0,y:0},v={x:0,y:0},d=[],h=c.set();t.$watch("imageSource",function(e){if(void 0!=e&&null!=e){var t=new Image;if(null!=s&&(s.remove(),h.length>0))for(var n=1;n<h.length;n++)h[n].remove();if("object"==typeof e){var o=new FileReader;t.onload=function(){s=c.image(o.result,0,0,t.width,t.height),s.toBack(),h.push(s)},o.onload=function(){t.src=o.result},o.readAsDataURL(e)}else"string"==typeof e&&(t.onload=function(){s=c.image(e,0,0,t.width,t.height),s.toBack(),h.push(s)},t.src=e)}}),t.$watch("overlays",function(e,t){null!=e&&null!=t&&(d.length>0&&angular.forEach(d,function(e){e.remove()}),angular.forEach(e,function(e){d=[];var t=c.rect(e.x,e.y,e.w,e.h,1);t.attr({fill:e.color,"fill-opacity":.4,"stroke-width":.2}),t.toFront(),h.push(t),d.push(t)}),a())},!0),t.mousedown=function(e){t.canMove=!0,u.x=e.layerX||e.offsetX,u.y=e.layerY||e.offsetY},t.mouseup=function(e){t.canMove=!1},t.mousedrag=function(e,n){if(null!=s&&t.canMove){var o=e.layerX||e.offsetX,i=e.layerY||e.offsetY,l=o-u.x,c=i-u.y;v.x+=1*l/r,v.y+=1*c/r,a(),u.x=o,u.y=i}},t.zoomin=function(){r+=.1,r>=6&&(r=6),a()},t.zoomout=function(){r-=.1,.05>=r&&(r=.05),a()},t.rotateleft=function(){f-=90,-360>=f&&(f=0),a()},t.rotateright=function(){f+=90,f>=360&&(f=0),a()}}}}]);