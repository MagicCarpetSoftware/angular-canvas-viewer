angular.module("RaphaelViewer",[]).directive("imageViewer",["$window",function(e){return{scope:{imageSource:"=src",overlays:"=overlays"},restrict:"E",template:'<div class="viewer"width="100%" height="100%"ng-mouseleave="canMove=false"ng-mousedown="mousedown($event)"ng-mouseup="mouseup($event)"ng-init="canMove=false"ng-mousemove="mousedrag($event,canMove)"><div class="command"><div class="btn btn-primary" ng-click="rotateleft()"><i class="fa fa-rotate-left"></i></div><div class="btn btn-primary" ng-click="rotateright()"><i class="fa fa-rotate-right"></i></div><div class="btn btn-primary" ng-click="zoomout()"><i class="fa fa-search-minus"></i></div><div class="btn btn-primary" ng-click="zoomin()"><i class="fa fa-search-plus"></i></div></div></div>',link:function(a,n,t,i){function o(){h.transform(Raphael.format("s{3},{4},0,0t{1},{2}r{0},0,0",u,v.x,v.y,s,s))}var r=n.find("div")[0],c=Raphael(r,e.width,e.height),l=null,s=1,u=0,f={x:0,y:0},v={x:0,y:0},m=[],h=c.set();a.$watch("imageSource",function(e){var a=new Image;a.onload=function(){l=c.image(e,0,0,a.width,a.height),l.toBack(),h.push(l)},a.src=e}),a.$watch("overlays",function(e,a){a.length==e.length&&angular.forEach(e,function(e){var a=c.rect(e.x,e.y,e.w,e.h,1);a.attr({fill:e.color,"fill-opacity":.7,"stroke-width":.2}),a.toFront(),h.push(a),m.push(a)}),e.length>a.length,o()},!0),a.mousedown=function(e){a.canMove=!0,f.x=e.layerX,f.y=e.layerY},a.mouseup=function(e){a.canMove=!1},a.mousedrag=function(e,n){if(null!=l&&a.canMove){var t=e.layerX-f.x,i=e.layerY-f.y;v.x+=1*t/s,v.y+=1*i/s,o(),f.x=e.layerX,f.y=e.layerY}},a.zoomin=function(){s+=.2,s>=6&&(s=6),o()},a.zoomout=function(){s-=.2,0>=s&&(s=.2),o()},a.rotateleft=function(){u-=90,-360>=u&&(u=0),o()},a.rotateright=function(){u+=90,u>=360&&(u=0),o()}}}}]);